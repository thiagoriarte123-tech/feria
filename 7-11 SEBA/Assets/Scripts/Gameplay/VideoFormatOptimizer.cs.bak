using UnityEngine;
using UnityEngine.Video;
using System.IO;

/// <summary>
/// Optimiza la carga de videos segÃºn el formato para mÃ¡xima velocidad
/// </summary>
public class VideoFormatOptimizer : MonoBehaviour
{
    [Header("Format Optimization")]
    public bool optimizeByFormat = true;
    public bool preferFasterFormats = true;
    
    [Header("Format Priority (Fastest to Slowest)")]
    public string[] formatPriority = { ".mp4", ".webm", ".mov", ".avi" };
    
    [Header("Loading Optimization")]
    public bool useHardwareDecoding = true;
    public bool preloadVideo = false;
    public VideoRenderMode optimizedRenderMode = VideoRenderMode.RenderTexture;
    
    private BackgroundVideoManager videoManager;
    
    void Start()
    {
        videoManager = GetComponent<BackgroundVideoManager>();
        if (videoManager != null && optimizeByFormat)
        {
            OptimizeVideoSettings();
        }
    }
    
    [ContextMenu("Optimize Video Settings")]
    public void OptimizeVideoSettings()
    {
        if (videoManager?.videoPlayer == null) return;
        
        VideoPlayer player = videoManager.videoPlayer;
        
        // ConfiguraciÃ³n optimizada para velocidad
        player.renderMode = optimizedRenderMode;
        player.skipOnDrop = true; // Saltar frames si es necesario
        player.playOnAwake = false;
        
        // OptimizaciÃ³n de audio (desactivado para velocidad)
        player.audioOutputMode = VideoAudioOutputMode.None;
        
        Debug.Log("ğŸš€ Video player optimizado para velocidad de carga");
    }
    
    /// <summary>
    /// Encuentra el video con el formato mÃ¡s rÃ¡pido disponible
    /// </summary>
    public string FindFastestVideoFormat(string songFolderPath)
    {
        if (!Directory.Exists(songFolderPath))
        {
            return null;
        }
        
        // Buscar en orden de prioridad (mÃ¡s rÃ¡pido primero)
        foreach (string format in formatPriority)
        {
            string[] files = Directory.GetFiles(songFolderPath, "*" + format);
            if (files.Length > 0)
            {
                string selectedFile = files[0];
                LogFormatInfo(selectedFile, format);
                return selectedFile;
            }
        }
        
        // Buscar nombres comunes con formatos rÃ¡pidos
        string[] commonNames = { "background", "video", "bg", "movie" };
        foreach (string name in commonNames)
        {
            foreach (string format in formatPriority)
            {
                string videoPath = Path.Combine(songFolderPath, name + format);
                if (File.Exists(videoPath))
                {
                    LogFormatInfo(videoPath, format);
                    return videoPath;
                }
            }
        }
        
        return null;
    }
    
    void LogFormatInfo(string videoPath, string format)
    {
        string speedRating = GetSpeedRating(format);
        Debug.Log($"ğŸ¬ Video encontrado: {Path.GetFileName(videoPath)} - Formato: {format} {speedRating}");
    }
    
    string GetSpeedRating(string format)
    {
        switch (format.ToLower())
        {
            case ".mp4":
                return "âš¡ (MÃS RÃPIDO)";
            case ".webm":
                return "ğŸš€ (RÃPIDO)";
            case ".mov":
                return "ğŸŒ (LENTO)";
            case ".avi":
                return "ğŸ¢ (MUY LENTO)";
            default:
                return "â“ (DESCONOCIDO)";
        }
    }
    
    [ContextMenu("Analyze Song Videos")]
    public void AnalyzeSongVideos()
    {
        string songsPath = Path.Combine(Application.streamingAssetsPath, "Songs");
        
        if (!Directory.Exists(songsPath))
        {
            Debug.LogWarning("ğŸ“ Carpeta Songs no encontrada");
            return;
        }
        
        Debug.Log("ğŸ“Š ANÃLISIS DE FORMATOS DE VIDEO:");
        Debug.Log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        
        string[] songFolders = Directory.GetDirectories(songsPath);
        int mp4Count = 0, webmCount = 0, movCount = 0, aviCount = 0;
        
        foreach (string folder in songFolders)
        {
            string songName = Path.GetFileName(folder);
            string fastestVideo = FindFastestVideoFormat(folder);
            
            if (!string.IsNullOrEmpty(fastestVideo))
            {
                string extension = Path.GetExtension(fastestVideo).ToLower();
                string speedInfo = GetSpeedRating(extension);
                
                Debug.Log($"ğŸµ {songName}: {Path.GetFileName(fastestVideo)} {speedInfo}");
                
                // Contar formatos
                switch (extension)
                {
                    case ".mp4": mp4Count++; break;
                    case ".webm": webmCount++; break;
                    case ".mov": movCount++; break;
                    case ".avi": aviCount++; break;
                }
            }
            else
            {
                Debug.Log($"ğŸµ {songName}: âŒ Sin video");
            }
        }
        
        Debug.Log("\nğŸ“ˆ RESUMEN DE FORMATOS:");
        Debug.Log($"   MP4 (MÃ¡s rÃ¡pido): {mp4Count}");
        Debug.Log($"   WebM (RÃ¡pido): {webmCount}");
        Debug.Log($"   MOV (Lento): {movCount}");
        Debug.Log($"   AVI (Muy lento): {aviCount}");
        
        // Recomendaciones
        if (movCount > 0 || aviCount > 0)
        {
            Debug.LogWarning("âš ï¸ RECOMENDACIÃ“N: Convierte los videos MOV/AVI a MP4 para carga mÃ¡s rÃ¡pida");
        }
        
        if (mp4Count == 0 && webmCount > 0)
        {
            Debug.Log("ğŸ’¡ TIP: Considera convertir algunos WebM a MP4 para mÃ¡xima velocidad");
        }
    }
    
    [ContextMenu("Show Format Recommendations")]
    public void ShowFormatRecommendations()
    {
        Debug.Log("ğŸ¯ RECOMENDACIONES DE FORMATO PARA VELOCIDAD:");
        Debug.Log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        Debug.Log("");
        Debug.Log("âš¡ MEJOR OPCIÃ“N - MP4 (H.264):");
        Debug.Log("   â€¢ Carga MÃS RÃPIDA");
        Debug.Log("   â€¢ Mejor compatibilidad con Unity");
        Debug.Log("   â€¢ DecodificaciÃ³n por hardware");
        Debug.Log("   â€¢ ConfiguraciÃ³n: 1080p, 30fps, 5-8 Mbps");
        Debug.Log("");
        Debug.Log("ğŸš€ SEGUNDA OPCIÃ“N - WebM (VP8):");
        Debug.Log("   â€¢ Carga rÃ¡pida");
        Debug.Log("   â€¢ Buena compresiÃ³n");
        Debug.Log("   â€¢ ConfiguraciÃ³n: 1080p, 30fps, 4-6 Mbps");
        Debug.Log("");
        Debug.Log("ğŸŒ EVITAR - MOV/AVI:");
        Debug.Log("   â€¢ Carga MUY LENTA");
        Debug.Log("   â€¢ Mayor uso de CPU");
        Debug.Log("   â€¢ Problemas de compatibilidad");
        Debug.Log("");
        Debug.Log("ğŸ› ï¸ HERRAMIENTAS DE CONVERSIÃ“N:");
        Debug.Log("   â€¢ FFmpeg (gratis, lÃ­nea de comandos)");
        Debug.Log("   â€¢ HandBrake (gratis, interfaz grÃ¡fica)");
        Debug.Log("   â€¢ Adobe Media Encoder (profesional)");
    }
    
    void Update()
    {
        // Tecla para anÃ¡lisis rÃ¡pido
        if (Input.GetKeyDown(KeyCode.F9))
        {
            AnalyzeSongVideos();
        }
        
        if (Input.GetKeyDown(KeyCode.F10))
        {
            ShowFormatRecommendations();
        }
    }
    
    void OnGUI()
    {
        if (!optimizeByFormat) return;
        
        GUILayout.BeginArea(new Rect(Screen.width - 300, Screen.height - 100, 290, 80));
        GUILayout.Label("ğŸš€ VIDEO FORMAT OPTIMIZER");
        GUILayout.Label("F9 - Analyze video formats");
        GUILayout.Label("F10 - Show recommendations");
        GUILayout.EndArea();
    }
}
